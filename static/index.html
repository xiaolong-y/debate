<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Debate</title>
  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Syntax highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css" media="(prefers-color-scheme: light)">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
  <!-- Math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg-primary: #FFFFFF;
    --bg-secondary: #F9FAFB;
    --bg-tertiary: #F3F4F6;
    --bg-thinking: #FEF7ED;
    --text-primary: #111827;
    --text-secondary: #4B5563;
    --text-muted: #9CA3AF;
    --border: #E5E7EB;
    --border-focus: #3B82F6;
    --accent-claude: #D97706;
    --accent-chatgpt: #10B981;
    --accent-gemini: #3B82F6;
    --accent-synthesis: #8B5CF6;
    --code-bg: #F3F4F6;
    --radius: 8px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg-primary: #111827;
      --bg-secondary: #1F2937;
      --bg-tertiary: #374151;
      --bg-thinking: #1C1917;
      --text-primary: #F9FAFB;
      --text-secondary: #D1D5DB;
      --text-muted: #6B7280;
      --border: #374151;
      --border-focus: #60A5FA;
      --accent-claude: #FBBF24;
      --accent-chatgpt: #34D399;
      --accent-gemini: #60A5FA;
      --accent-synthesis: #A78BFA;
      --code-bg: #1F2937;
    }
  }

  html, body {
    height: 100%;
    font: 15px/1.6 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-secondary);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
  }

  .container {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
    gap: 20px;
  }

  /* Header */
  header {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  header h1 {
    font-size: 1.5em;
    font-weight: 600;
    background: linear-gradient(135deg, var(--accent-claude), var(--accent-synthesis));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .prompt-form {
    display: flex;
    flex: 1;
    gap: 12px;
    min-width: 300px;
  }

  .prompt-input {
    flex: 1;
    padding: 14px 18px;
    font: inherit;
    font-size: 15px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: all 0.2s;
  }

  .prompt-input:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .prompt-input::placeholder { color: var(--text-muted); }

  .submit-btn {
    padding: 14px 28px;
    font: inherit;
    font-weight: 600;
    border: none;
    border-radius: var(--radius);
    background: linear-gradient(135deg, #3B82F6, #8B5CF6);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }

  .submit-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Status bar */
  .status-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.9em;
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  .status-bar.error { border-color: #EF4444; color: #EF4444; }
  .status-bar.success { border-color: #10B981; color: #10B981; }

  .connection-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-muted);
  }
  .connection-dot.connected { background: #10B981; }
  .connection-dot.disconnected { background: #EF4444; }

  /* Main grid */
  .columns {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    flex: 1;
    min-height: 0;
  }

  @media (max-width: 1200px) {
    .columns { grid-template-columns: 1fr; }
  }

  /* Panes */
  .pane {
    display: flex;
    flex-direction: column;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s;
  }

  .pane.streaming { border-color: var(--accent-gemini); }
  .pane.complete { border-color: #10B981; }
  .pane.error { border-color: #EF4444; }

  .pane-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-secondary);
    gap: 12px;
  }

  .pane-title {
    font-weight: 600;
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .pane[data-source="claude"] .pane-title { color: var(--accent-claude); }
  .pane[data-source="chatgpt"] .pane-title { color: var(--accent-chatgpt); }
  .pane[data-source="gemini"] .pane-title { color: var(--accent-gemini); }

  .pane-meta {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .pane-status {
    font-size: 0.75em;
    font-family: 'JetBrains Mono', monospace;
    padding: 4px 10px;
    border-radius: 20px;
    background: var(--bg-tertiary);
    color: var(--text-muted);
  }

  .pane-status.streaming { background: rgba(59, 130, 246, 0.1); color: var(--accent-gemini); }
  .pane-status.complete { background: rgba(16, 185, 129, 0.1); color: #10B981; }
  .pane-status.error { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

  .pane-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .pane-content.empty .response-text:empty::after {
    content: "Waiting for response...";
    display: block;
    padding: 20px;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Thinking indicator (animated) */
  .thinking-live {
    display: none;
    padding: 16px 20px;
    background: var(--bg-thinking);
    border-bottom: 1px solid var(--border);
  }

  .thinking-live.active { display: block; }

  .thinking-live-header {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85em;
    font-weight: 500;
    color: var(--accent-synthesis);
    margin-bottom: 10px;
  }

  .thinking-live-dots {
    display: flex;
    gap: 4px;
  }

  .thinking-live-dots span {
    width: 6px;
    height: 6px;
    background: var(--accent-synthesis);
    border-radius: 50%;
    animation: dotPulse 1.4s ease-in-out infinite;
  }
  .thinking-live-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-live-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes dotPulse {
    0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  .thinking-live-preview {
    font-size: 0.85em;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    white-space: pre-wrap;
    max-height: 80px;
    overflow: hidden;
    position: relative;
  }

  .thinking-live-preview::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: linear-gradient(transparent, var(--bg-thinking));
  }

  /* Thinking block (collapsible, completed) */
  .thinking-block {
    margin: 16px 20px;
    border-radius: var(--radius);
    background: var(--bg-thinking);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .thinking-block-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    font-size: 0.85em;
    color: var(--text-secondary);
    transition: background 0.2s;
  }

  .thinking-block-header:hover { background: rgba(139, 92, 246, 0.05); }

  .thinking-block-icon {
    width: 16px;
    height: 16px;
    color: var(--accent-synthesis);
    transition: transform 0.2s;
  }

  .thinking-block.collapsed .thinking-block-icon { transform: rotate(-90deg); }

  .thinking-block-label { color: var(--accent-synthesis); font-weight: 500; }

  .thinking-block-content {
    padding: 0 16px 16px;
    font-size: 0.88em;
    color: var(--text-secondary);
    line-height: 1.7;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: 'JetBrains Mono', monospace;
  }

  .thinking-block.collapsed .thinking-block-content {
    display: none;
  }

  /* Response content - Claude.ai style markdown */
  .response-text {
    padding: 20px;
    font-size: 0.95em;
    line-height: 1.75;
  }

  .response-text h1, .response-text h2, .response-text h3, .response-text h4 {
    margin: 1.5em 0 0.75em;
    font-weight: 600;
    line-height: 1.3;
    color: var(--text-primary);
  }

  .response-text h1:first-child, .response-text h2:first-child, .response-text h3:first-child {
    margin-top: 0;
  }

  .response-text h1 { font-size: 1.5em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
  .response-text h2 { font-size: 1.3em; }
  .response-text h3 { font-size: 1.1em; }

  .response-text p { margin: 0.75em 0; }

  .response-text ul, .response-text ol {
    margin: 0.75em 0;
    padding-left: 1.75em;
  }

  .response-text li {
    margin: 0.4em 0;
    padding-left: 0.25em;
  }

  .response-text li::marker {
    color: var(--text-muted);
  }

  /* Inline code */
  .response-text code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.88em;
    background: var(--code-bg);
    padding: 2px 6px;
    border-radius: 4px;
    color: #DB2777;
  }

  /* Code blocks */
  .response-text pre {
    margin: 1em 0;
    border-radius: var(--radius);
    overflow: hidden;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
  }

  .response-text pre code {
    display: block;
    padding: 16px;
    overflow-x: auto;
    font-size: 0.85em;
    line-height: 1.6;
    background: none;
    color: inherit;
  }

  /* Code block header with language */
  .code-block-wrapper {
    position: relative;
  }

  .code-block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
    font-size: 0.75em;
    font-family: 'JetBrains Mono', monospace;
    color: var(--text-muted);
  }

  .copy-code-btn {
    padding: 4px 8px;
    font: inherit;
    font-size: 0.85em;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-code-btn:hover {
    border-color: var(--border-focus);
    color: var(--text-primary);
  }

  /* Blockquotes */
  .response-text blockquote {
    margin: 1em 0;
    padding: 0.5em 1em;
    border-left: 4px solid var(--accent-synthesis);
    background: var(--bg-secondary);
    border-radius: 0 var(--radius) var(--radius) 0;
    color: var(--text-secondary);
  }

  /* Tables */
  .response-text table {
    width: 100%;
    margin: 1em 0;
    border-collapse: collapse;
    font-size: 0.9em;
  }

  .response-text th, .response-text td {
    padding: 10px 14px;
    border: 1px solid var(--border);
    text-align: left;
  }

  .response-text th {
    background: var(--bg-secondary);
    font-weight: 600;
  }

  /* Strong and emphasis */
  .response-text strong { font-weight: 600; color: var(--text-primary); }
  .response-text em { font-style: italic; }

  /* Horizontal rule */
  .response-text hr {
    margin: 2em 0;
    border: none;
    border-top: 1px solid var(--border);
  }

  /* Math blocks */
  .response-text .katex-display {
    margin: 1em 0;
    overflow-x: auto;
    padding: 0.5em 0;
  }

  /* Copy button */
  .copy-btn {
    padding: 6px 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75em;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-primary);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-btn:hover {
    border-color: var(--border-focus);
    color: var(--text-primary);
  }

  .copy-btn.copied {
    border-color: #10B981;
    color: #10B981;
    background: rgba(16, 185, 129, 0.1);
  }

  /* Triage overlay */
  .triage-overlay {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 75vh;
    background: var(--bg-primary);
    border-top: 2px solid var(--accent-synthesis);
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.15);
    border-radius: 20px 20px 0 0;
    transform: translateY(calc(100% - 60px));
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    display: flex;
    flex-direction: column;
  }

  .triage-overlay.expanded { transform: translateY(0); }

  .triage-handle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    cursor: pointer;
    background: var(--bg-secondary);
    border-radius: 20px 20px 0 0;
    flex-shrink: 0;
  }

  .triage-handle:hover { background: var(--bg-tertiary); }

  .triage-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    color: var(--accent-synthesis);
  }

  .triage-title svg { width: 22px; height: 22px; }

  .new-badge {
    display: none;
    padding: 3px 10px;
    border-radius: 20px;
    background: var(--accent-synthesis);
    color: #fff;
    font-size: 0.7em;
    font-weight: 600;
    animation: pulse 1.5s ease-in-out infinite;
  }

  .triage-overlay.has-new:not(.expanded) .new-badge { display: inline-block; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .triage-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border: 1px solid var(--accent-synthesis);
    border-radius: var(--radius);
    background: transparent;
    color: var(--accent-synthesis);
    font: inherit;
    font-size: 0.85em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .triage-toggle:hover {
    background: var(--accent-synthesis);
    color: #fff;
  }

  .triage-toggle svg {
    width: 16px;
    height: 16px;
    transition: transform 0.3s;
  }

  .triage-overlay.expanded .triage-toggle svg { transform: rotate(180deg); }

  .triage-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .triage-content.empty .response-text:empty::after {
    content: "Unified analysis will appear here after all models respond...";
    display: block;
    padding: 24px;
    color: var(--text-muted);
    font-style: italic;
  }

  .triage-actions {
    display: flex;
    gap: 10px;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    background: var(--bg-secondary);
    flex-shrink: 0;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* Selection */
  ::selection {
    background: rgba(139, 92, 246, 0.2);
  }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>LLM Debate</h1>
      <form class="prompt-form" id="prompt-form">
        <input type="text" class="prompt-input" id="prompt-input"
               placeholder="Ask anything... Claude, ChatGPT, and Gemini will respond and synthesize"
               autocomplete="off">
        <button type="submit" class="submit-btn" id="submit-btn">Debate</button>
      </form>
    </header>

    <div class="status-bar" id="status-bar">
      <span class="connection-dot" id="connection-dot"></span>
      <span id="status-text">Connecting...</span>
    </div>

    <div class="columns">
      <div class="pane" data-source="claude" id="pane-claude">
        <div class="pane-header">
          <span class="pane-title">Claude</span>
          <div class="pane-meta">
            <span class="pane-status" id="status-claude">idle</span>
            <button class="copy-btn" data-copy="claude">Copy</button>
          </div>
        </div>
        <div class="pane-content empty" id="content-claude">
          <div class="thinking-live" id="thinking-live-claude">
            <div class="thinking-live-header">
              <span>Thinking</span>
              <div class="thinking-live-dots"><span></span><span></span><span></span></div>
            </div>
            <div class="thinking-live-preview" id="thinking-preview-claude"></div>
          </div>
          <div class="response-text" id="response-claude"></div>
        </div>
      </div>

      <div class="pane" data-source="chatgpt" id="pane-chatgpt">
        <div class="pane-header">
          <span class="pane-title">ChatGPT</span>
          <div class="pane-meta">
            <span class="pane-status" id="status-chatgpt">idle</span>
            <button class="copy-btn" data-copy="chatgpt">Copy</button>
          </div>
        </div>
        <div class="pane-content empty" id="content-chatgpt">
          <div class="thinking-live" id="thinking-live-chatgpt">
            <div class="thinking-live-header">
              <span>Thinking</span>
              <div class="thinking-live-dots"><span></span><span></span><span></span></div>
            </div>
            <div class="thinking-live-preview" id="thinking-preview-chatgpt"></div>
          </div>
          <div class="response-text" id="response-chatgpt"></div>
        </div>
      </div>

      <div class="pane" data-source="gemini" id="pane-gemini">
        <div class="pane-header">
          <span class="pane-title">Gemini</span>
          <div class="pane-meta">
            <span class="pane-status" id="status-gemini">idle</span>
            <button class="copy-btn" data-copy="gemini">Copy</button>
          </div>
        </div>
        <div class="pane-content empty" id="content-gemini">
          <div class="thinking-live" id="thinking-live-gemini">
            <div class="thinking-live-header">
              <span>Thinking</span>
              <div class="thinking-live-dots"><span></span><span></span><span></span></div>
            </div>
            <div class="thinking-live-preview" id="thinking-preview-gemini"></div>
          </div>
          <div class="response-text" id="response-gemini"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Triage Overlay -->
  <div class="triage-overlay" id="triage-overlay">
    <div class="triage-handle" id="triage-handle">
      <div class="triage-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 17l10 5 10-5"/>
          <path d="M2 12l10 5 10-5"/>
        </svg>
        Unified Analysis
        <span class="new-badge">NEW</span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <span class="pane-status" id="status-synthesis">idle</span>
        <button class="triage-toggle" id="triage-toggle">
          <span>Expand</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="18 15 12 9 6 15"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="triage-content empty" id="content-synthesis">
      <div class="thinking-live" id="thinking-live-synthesis">
        <div class="thinking-live-header">
          <span>Analyzing responses</span>
          <div class="thinking-live-dots"><span></span><span></span><span></span></div>
        </div>
        <div class="thinking-live-preview" id="thinking-preview-synthesis"></div>
      </div>
      <div class="response-text" id="response-synthesis"></div>
    </div>
    <div class="triage-actions">
      <button class="copy-btn" data-copy="synthesis">Copy Analysis</button>
    </div>
  </div>

  <script>
  // State
  const state = {
    ws: null,
    connected: false,
    debating: false,
    triageExpanded: false,
    responses: { claude: '', chatgpt: '', gemini: '', synthesis: '' },
    rawMarkdown: { claude: '', chatgpt: '', gemini: '', synthesis: '' },
    thinkingContent: { claude: '', chatgpt: '', gemini: '', synthesis: '' },
    startTime: { claude: null, chatgpt: null, gemini: null, synthesis: null },
    isStreaming: { claude: false, chatgpt: false, gemini: false, synthesis: false }
  };

  // Elements
  const form = document.getElementById('prompt-form');
  const input = document.getElementById('prompt-input');
  const submitBtn = document.getElementById('submit-btn');
  const statusText = document.getElementById('status-text');
  const connectionDot = document.getElementById('connection-dot');
  const triageOverlay = document.getElementById('triage-overlay');
  const triageHandle = document.getElementById('triage-handle');
  const triageToggle = document.getElementById('triage-toggle');

  // Configure marked with syntax highlighting
  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        try {
          return hljs.highlight(code, { language: lang }).value;
        } catch (e) {}
      }
      return hljs.highlightAuto(code).value;
    }
  });

  // Custom renderer for code blocks with copy button
  const renderer = new marked.Renderer();
  renderer.code = function(code, language) {
    const lang = language || 'text';
    const highlighted = lang && hljs.getLanguage(lang)
      ? hljs.highlight(code, { language: lang }).value
      : hljs.highlightAuto(code).value;

    const escaped = code.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
    return `<div class="code-block-wrapper">
      <div class="code-block-header">
        <span>${lang}</span>
        <button class="copy-code-btn" onclick="copyCode(this, '${escaped}')">Copy</button>
      </div>
      <pre><code class="hljs language-${lang}">${highlighted}</code></pre>
    </div>`;
  };
  marked.setOptions({ renderer });

  // Copy code function
  window.copyCode = function(btn, code) {
    const decoded = code.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
    navigator.clipboard.writeText(decoded).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    });
  };

  // Triage toggle
  triageHandle.addEventListener('click', toggleTriage);
  triageToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleTriage(); });

  function toggleTriage() {
    state.triageExpanded = !state.triageExpanded;
    triageOverlay.classList.toggle('expanded', state.triageExpanded);
    triageOverlay.classList.remove('has-new');
    triageToggle.querySelector('span').textContent = state.triageExpanded ? 'Collapse' : 'Expand';
  }

  // WebSocket connection
  function connect() {
    const sessionId = crypto.randomUUID();
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    state.ws = new WebSocket(`${protocol}//${window.location.host}/ws/${sessionId}`);

    state.ws.onopen = () => {
      state.connected = true;
      setConnectionStatus(true);
      setStatus('Connected. Ready for debate.');
      enableForm(true);
    };

    state.ws.onclose = () => {
      state.connected = false;
      setConnectionStatus(false);
      setStatus('Disconnected. Reconnecting...', 'error');
      enableForm(false);
      setTimeout(connect, 2000);
    };

    state.ws.onerror = console.error;
    state.ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
  }

  // Handle messages
  function handleMessage(msg) {
    switch (msg.type) {
      case 'chunk':
        if (!state.isStreaming[msg.source]) {
          state.isStreaming[msg.source] = true;
          state.startTime[msg.source] = Date.now();
          showThinkingLive(msg.source, true);
        }
        state.responses[msg.source] += msg.content;
        state.rawMarkdown[msg.source] += msg.content;
        updateThinkingPreview(msg.source);
        setSourceStatus(msg.source, 'streaming');

        if (msg.source === 'synthesis' && !state.triageExpanded) {
          triageOverlay.classList.add('has-new');
        }
        break;

      case 'complete':
        const duration = state.startTime[msg.source]
          ? Math.round((Date.now() - state.startTime[msg.source]) / 1000)
          : 0;

        state.isStreaming[msg.source] = false;
        state.responses[msg.source] = msg.content;
        state.rawMarkdown[msg.source] = msg.content;
        showThinkingLive(msg.source, false);
        renderContent(msg.source, msg.content, duration);
        setSourceStatus(msg.source, 'complete');

        if (msg.source === 'synthesis') {
          state.debating = false;
          enableForm(true);
          setStatus('Analysis complete!', 'success');
          if (!state.triageExpanded) toggleTriage();
        }
        break;

      case 'status':
        setStatus(msg.message);
        break;

      case 'error':
        state.isStreaming[msg.source] = false;
        showThinkingLive(msg.source, false);
        setSourceStatus(msg.source, 'error');
        if (['auth', 'system', 'debate'].includes(msg.source)) {
          setStatus(msg.message, 'error');
          state.debating = false;
          enableForm(true);
        }
        break;
    }
  }

  // Show/hide live thinking indicator
  function showThinkingLive(source, show) {
    const el = document.getElementById(`thinking-live-${source}`);
    if (el) el.classList.toggle('active', show);
  }

  // Update thinking preview during streaming
  function updateThinkingPreview(source) {
    const el = document.getElementById(`thinking-preview-${source}`);
    if (el) {
      const text = state.responses[source];
      el.textContent = text.length > 300 ? '...' + text.slice(-300) : text;
    }
  }

  // Parse content to separate thinking from response
  function parseThinkingContent(content) {
    // Try to detect thinking patterns
    // Pattern 1: <thinking>...</thinking> tags
    const thinkingMatch = content.match(/<thinking>([\s\S]*?)<\/thinking>/i);
    if (thinkingMatch) {
      const thinking = thinkingMatch[1].trim();
      const response = content.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '').trim();
      return { thinking, response };
    }

    // Pattern 2: Text before first markdown header is thinking
    const headerMatch = content.match(/^([\s\S]*?)((?:^|\n)#{1,3}\s)/m);
    if (headerMatch && headerMatch[1].trim().length > 100) {
      return { thinking: headerMatch[1].trim(), response: content.slice(headerMatch[1].length).trim() };
    }

    // Pattern 3: For synthesis, look for "## Consensus" or similar structural headers
    const synthesisHeaderMatch = content.match(/^([\s\S]*?)((?:^|\n)##\s+(?:Consensus|Key|Synthesized|Agreement))/mi);
    if (synthesisHeaderMatch && synthesisHeaderMatch[1].trim().length > 50) {
      return { thinking: synthesisHeaderMatch[1].trim(), response: content.slice(synthesisHeaderMatch[1].length).trim() };
    }

    return { thinking: '', response: content };
  }

  // Render final content with optional thinking block
  function renderContent(source, content, duration) {
    const contentEl = document.getElementById(`content-${source}`);
    const responseEl = document.getElementById(`response-${source}`);
    if (!contentEl || !responseEl) return;

    contentEl.classList.remove('empty');

    if (!content) {
      responseEl.innerHTML = '';
      contentEl.classList.add('empty');
      return;
    }

    // Parse thinking vs response
    const { thinking, response } = parseThinkingContent(content);
    state.thinkingContent[source] = thinking;

    let html = '';

    // Add collapsible thinking block if there's thinking content
    if (thinking && thinking.length > 50) {
      const durationText = duration > 0 ? ` for ${duration}s` : '';
      html += `
        <div class="thinking-block collapsed" id="thinking-block-${source}">
          <div class="thinking-block-header" onclick="toggleThinking('${source}')">
            <svg class="thinking-block-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
            <span class="thinking-block-label">Thought${durationText}</span>
          </div>
          <div class="thinking-block-content">${escapeHtml(thinking)}</div>
        </div>
      `;
    }

    // Render main response as markdown
    try {
      html += marked.parse(response || content);
    } catch (e) {
      html += `<p>${escapeHtml(response || content)}</p>`;
    }

    responseEl.innerHTML = html;

    // Render math
    if (window.renderMathInElement) {
      renderMathInElement(responseEl, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
          {left: '\\[', right: '\\]', display: true},
          {left: '\\(', right: '\\)', display: false}
        ],
        throwOnError: false
      });
    }

    // Scroll to bottom
    contentEl.scrollTop = contentEl.scrollHeight;
  }

  // Toggle thinking block
  window.toggleThinking = function(source) {
    const block = document.getElementById(`thinking-block-${source}`);
    if (block) block.classList.toggle('collapsed');
  };

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // UI helpers
  function setStatus(message, type = '') {
    statusText.textContent = message;
    const bar = document.getElementById('status-bar');
    bar.classList.remove('error', 'success');
    if (type) bar.classList.add(type);
  }

  function setConnectionStatus(connected) {
    connectionDot.classList.toggle('connected', connected);
    connectionDot.classList.toggle('disconnected', !connected);
  }

  function enableForm(enabled) {
    input.disabled = !enabled;
    submitBtn.disabled = !enabled || state.debating;
  }

  function setSourceStatus(source, status) {
    const el = document.getElementById(`status-${source}`);
    const pane = document.getElementById(`pane-${source}`);

    if (el) {
      el.textContent = status;
      el.className = 'pane-status';
      if (status !== 'idle') el.classList.add(status);
    }

    if (pane) {
      pane.classList.remove('streaming', 'complete', 'error');
      if (status !== 'idle') pane.classList.add(status);
    }
  }

  function clearAll() {
    ['claude', 'chatgpt', 'gemini', 'synthesis'].forEach(source => {
      state.responses[source] = '';
      state.rawMarkdown[source] = '';
      state.thinkingContent[source] = '';
      state.startTime[source] = null;
      state.isStreaming[source] = false;

      const responseEl = document.getElementById(`response-${source}`);
      if (responseEl) responseEl.innerHTML = '';

      const previewEl = document.getElementById(`thinking-preview-${source}`);
      if (previewEl) previewEl.textContent = '';

      showThinkingLive(source, false);

      const contentEl = document.getElementById(`content-${source}`);
      if (contentEl) contentEl.classList.add('empty');

      setSourceStatus(source, 'idle');
    });
    triageOverlay.classList.remove('has-new');
  }

  // Form submission
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const prompt = input.value.trim();
    if (!prompt || !state.connected || state.debating) return;

    clearAll();
    state.debating = true;
    enableForm(false);
    setStatus('Starting debate...');

    if (state.triageExpanded) toggleTriage();

    state.ws.send(JSON.stringify({ action: 'debate', prompt }));
  });

  // Copy buttons - copy raw markdown
  document.querySelectorAll('.copy-btn[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => {
      const source = btn.dataset.copy;
      const text = state.rawMarkdown[source];
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          btn.textContent = 'Copied!';
          btn.classList.add('copied');
          setTimeout(() => {
            btn.textContent = source === 'synthesis' ? 'Copy Analysis' : 'Copy';
            btn.classList.remove('copied');
          }, 1500);
        });
      }
    });
  });

  // Keyboard shortcut
  input.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      e.preventDefault();
      form.dispatchEvent(new Event('submit'));
    }
  });

  // Initialize
  input.focus();
  connect();

  // Handle URL params
  const params = new URLSearchParams(window.location.search);
  const promptParam = params.get('prompt');
  if (promptParam) {
    input.value = promptParam;
    const checkAndSubmit = () => {
      if (state.connected) {
        setTimeout(() => form.dispatchEvent(new Event('submit')), 500);
      } else {
        setTimeout(checkAndSubmit, 100);
      }
    };
    checkAndSubmit();
  }
  </script>
</body>
</html>
