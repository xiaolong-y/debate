#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
DEBATE_DIR="$(dirname "$SCRIPT_DIR")"
PYTHON="$DEBATE_DIR/.venv/bin/python"
PORT=8765

# Turbo mode URLs
CLAUDE="https://claude.ai/new"
CHATGPT="https://chatgpt.com/"
GEMINI="https://gemini.google.com/app"

usage() {
    echo "debate - Multi-LLM query tool"
    echo ""
    echo "Usage:"
    echo "  debate \"prompt\"           Turbo mode: opens all 3 windows instantly"
    echo "  debate go \"prompt\"        Explicit turbo mode"
    echo "  debate run \"prompt\"       Full mode: automation + synthesis"
    echo "  debate auth               Set up login sessions"
    echo "  debate check              Check auth status"
    echo "  debate kill               Stop server"
    echo "  debate server             Start server only"
    echo ""
    echo "Examples:"
    echo "  debate \"What is the meaning of life?\""
    echo "  debate run \"Compare React vs Vue\""
    exit 0
}

kill_server() {
    lsof -ti :$PORT 2>/dev/null | xargs kill -9 2>/dev/null || true
}

turbo_open() {
    # Copy prompt to clipboard if provided
    if [ -n "$1" ]; then
        echo -n "$*" | pbcopy
        echo "ðŸ“‹ Prompt copied (${#1} chars)"
    fi

    # Open all URLs in parallel
    echo "ðŸš€ Opening LLM windows..."
    open "$CLAUDE" &
    open "$CHATGPT" &
    open "$GEMINI" &

    echo "   âœ“ Claude"
    echo "   âœ“ ChatGPT"
    echo "   âœ“ Gemini"

    if [ -n "$1" ]; then
        echo ""
        echo "ðŸ’¡ Press âŒ˜V in each chat window to paste"
    fi
}

case "${1:-}" in
    go)
        shift
        turbo_open "$@"
        ;;
    run)
        shift
        if [ -z "$1" ]; then
            echo "Error: Please provide a prompt"
            echo "Usage: debate run \"your prompt here\""
            exit 1
        fi
        kill_server
        sleep 0.5
        exec "$PYTHON" "$DEBATE_DIR/debate.py" run "$@"
        ;;
    auth)
        exec "$PYTHON" "$DEBATE_DIR/debate.py" auth
        ;;
    check)
        exec "$PYTHON" "$DEBATE_DIR/debate.py" check
        ;;
    kill)
        kill_server
        echo "âœ“ Killed any debate server on port $PORT"
        ;;
    server)
        kill_server
        sleep 0.5
        exec "$PYTHON" "$DEBATE_DIR/debate.py" server
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        # Default: turbo mode with prompt
        turbo_open "$@"
        ;;
esac
